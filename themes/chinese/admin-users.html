<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理 - {{siteName}}</title>
    
    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chinese Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --chinese-red: #c41e3a;
            --chinese-red-dark: #8b0000;
            --chinese-gold: #d4a017;
            --ink-black: #1a1a1a;
            --paper-cream: #faf8f5;
            --cloud-white: #fefefe;
        }
        
        * { font-family: 'Noto Serif SC', serif; }
        body { background: var(--paper-cream); min-height: 100vh; }
        
        .navbar-chinese {
            background: linear-gradient(135deg, var(--chinese-red) 0%, var(--chinese-red-dark) 100%);
        }
        
        .navbar-chinese .navbar-brand {
            font-family: 'ZCOOL XiaoWei', serif;
            color: var(--chinese-gold) !important;
        }
        
        .navbar-chinese .navbar-item {
            color: var(--paper-cream) !important;
        }
        
        .sidebar-chinese {
            background: var(--ink-black);
            min-height: calc(100vh - 52px);
            padding: 1.5rem 0;
        }
        
        .sidebar-chinese .menu-list a {
            color: rgba(255,255,255,0.7);
            padding: 0.75rem 1.5rem;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .sidebar-chinese .menu-list a:hover,
        .sidebar-chinese .menu-list a.is-active {
            background: rgba(196, 30, 58, 0.3);
            color: var(--paper-cream);
            border-left-color: var(--chinese-gold);
        }
        
        .content-area { padding: 2rem; }
        
        .card-chinese {
            background: var(--cloud-white);
            border-radius: 4px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            border: 1px solid rgba(212, 160, 23, 0.2);
        }
        
        .card-chinese .card-header {
            background: transparent;
            border-bottom: 1px solid rgba(212, 160, 23, 0.2);
        }
        
        .card-chinese .card-header-title {
            font-family: 'ZCOOL XiaoWei', serif;
            color: var(--ink-black);
        }
        
        .stat-card {
            background: var(--cloud-white);
            border-radius: 4px;
            padding: 1.5rem;
            border: 1px solid rgba(212, 160, 23, 0.2);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--paper-cream);
            font-family: 'ZCOOL XiaoWei', serif;
            font-size: 1.25rem;
        }
        
        .avatar-superadmin { background: linear-gradient(135deg, var(--chinese-gold) 0%, #b8860b 100%); }
        .avatar-admin { background: linear-gradient(135deg, var(--chinese-red) 0%, var(--chinese-red-dark) 100%); }
        
        .tag-superadmin { background: linear-gradient(135deg, var(--chinese-gold) 0%, #b8860b 100%); color: var(--ink-black); }
        .tag-admin { background: linear-gradient(135deg, var(--chinese-red) 0%, var(--chinese-red-dark) 100%); color: var(--paper-cream); }
        
        .btn-chinese {
            background: linear-gradient(135deg, var(--chinese-red) 0%, var(--chinese-red-dark) 100%);
            color: var(--paper-cream);
            border: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-chinese:hover {
            transform: translateY(-2px);
            color: var(--chinese-gold);
        }
        
        .table-chinese thead th {
            background: linear-gradient(135deg, var(--chinese-red) 0%, var(--chinese-red-dark) 100%);
            color: var(--paper-cream);
            font-weight: 500;
        }
        
        .modal-chinese .modal-card-head {
            background: linear-gradient(135deg, var(--chinese-red) 0%, var(--chinese-red-dark) 100%);
        }
        
        .modal-chinese .modal-card-title {
            color: var(--paper-cream);
            font-family: 'ZCOOL XiaoWei', serif;
        }
        
        @media (max-width: 1024px) {
            .sidebar-chinese { min-height: auto; }
        }
    </style>
    
    {{codeBeforHead}}
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-chinese">
        <div class="container-fluid">
            <div class="navbar-brand">
                <span class="navbar-item"><i class="fas fa-users me-2"></i>用户管理</span>
            </div>
            <div class="navbar-menu">
                <div class="navbar-end">
                    <a href="/admin/" class="navbar-item"><i class="fas fa-arrow-left me-1"></i> 返回</a>
                    <a href="/" class="navbar-item"><i class="fas fa-eye me-1"></i> 查看博客</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="columns is-gapless">
        <!-- Sidebar -->
        <div class="column is-2 sidebar-chinese">
            <aside class="menu">
                <ul class="menu-list">
                    <li><a href="/admin/"><i class="fas fa-file-alt me-2"></i>文章管理</a></li>
                    <li><a class="is-active"><i class="fas fa-users me-2"></i>用户管理</a></li>
                    <li><a href="/admin/edit"><i class="fas fa-plus me-2"></i>新建文章</a></li>
                </ul>
            </aside>
        </div>
        
        <!-- Content -->
        <div class="column content-area">
            <!-- Stats -->
            <div class="columns mb-5">
                <div class="column is-4">
                    <div class="stat-card is-flex is-align-items-center gap-3">
                        <div class="user-avatar avatar-admin"><i class="fas fa-user-plus"></i></div>
                        <button onclick="openAddAdminModal()" class="button btn-chinese">添加管理员</button>
                    </div>
                </div>
                <div class="column is-4">
                    <div class="stat-card is-flex is-align-items-center gap-3">
                        <div class="user-avatar avatar-admin"><i class="fas fa-users"></i></div>
                        <div>
                            <h3 class="title is-4 mb-0" id="total-admins">0</h3>
                            <p class="has-text-grey">管理员总数</p>
                        </div>
                    </div>
                </div>
                <div class="column is-4">
                    <div class="stat-card is-flex is-align-items-center gap-3">
                        <div class="user-avatar avatar-superadmin"><i class="fas fa-shield-alt"></i></div>
                        <div>
                            <h3 class="title is-4 mb-0" id="superadmin-count">0</h3>
                            <p class="has-text-grey">超级管理员</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="card card-chinese">
                <header class="card-header">
                    <p class="card-header-title"><i class="fas fa-user-cog me-2"></i>用户列表</p>
                </header>
                <div class="card-content">
                    <div id="admins-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Admin Modal -->
    <div class="modal modal-chinese" id="addAdminModal">
        <div class="modal-background" onclick="closeAddAdminModal()"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">添加管理员</p>
                <button class="delete" onclick="closeAddAdminModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="field">
                    <label class="label">用户名 *</label>
                    <input class="input" type="text" id="username">
                </div>
                <div class="field">
                    <label class="label">密码 *</label>
                    <input class="input" type="password" id="password">
                </div>
                <div class="field">
                    <label class="label">邮箱 *</label>
                    <input class="input" type="email" id="email">
                </div>
                <div class="field">
                    <label class="label">角色 *</label>
                    <div class="select is-fullwidth">
                        <select id="role">
                            <option value="admin">管理员</option>
                            <option value="superadmin">超级管理员</option>
                        </select>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button" onclick="closeAddAdminModal()">取消</button>
                <button class="button btn-chinese" onclick="addAdmin()">添加</button>
            </footer>
        </div>
    </div>

    <!-- Edit Admin Modal -->
    <div class="modal modal-chinese" id="editAdminModal">
        <div class="modal-background" onclick="closeEditAdminModal()"></div>
        <div class="modal-card">
            <header class="modal-card-head">
                <p class="modal-card-title">编辑管理员</p>
                <button class="delete" onclick="closeEditAdminModal()"></button>
            </header>
            <section class="modal-card-body">
                <input type="hidden" id="edit-admin-id">
                <div class="field">
                    <label class="label">用户名</label>
                    <input class="input" type="text" id="edit-username" readonly>
                </div>
                <div class="field">
                    <label class="label">邮箱 *</label>
                    <input class="input" type="email" id="edit-email">
                </div>
                <div class="field">
                    <label class="label">角色 *</label>
                    <div class="select is-fullwidth">
                        <select id="edit-role">
                            <option value="admin">管理员</option>
                            <option value="superadmin">超级管理员</option>
                        </select>
                    </div>
                </div>
                <div class="field">
                    <label class="label">状态 *</label>
                    <div class="select is-fullwidth">
                        <select id="edit-status">
                            <option value="active">活跃</option>
                            <option value="inactive">停用</option>
                        </select>
                    </div>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button" onclick="closeEditAdminModal()">取消</button>
                <button class="button btn-chinese" onclick="updateAdmin()">保存</button>
            </footer>
        </div>
    </div>

    <script>
        let currentAdmins = [];

        async function loadAdmins() {
            try {
                const response = await fetch('/api/admins');
                if (!response.ok) {
                    if (response.status === 403) {
                        document.getElementById('admins-list').innerHTML = '<div class="notification is-danger">权限不足，需要超级管理员权限</div>';
                        return;
                    }
                    throw new Error('加载失败');
                }
                
                currentAdmins = await response.json();
                displayAdmins();
                updateStats();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function displayAdmins() {
            const container = document.getElementById('admins-list');
            if (currentAdmins.length === 0) {
                container.innerHTML = '<div class="has-text-centered py-5"><i class="fas fa-users fa-3x has-text-grey-light mb-3"></i><p class="has-text-grey">暂无管理员</p></div>';
                return;
            }

            container.innerHTML = `
                <table class="table is-fullwidth table-chinese">
                    <thead><tr><th>用户</th><th>角色</th><th>状态</th><th>操作</th></tr></thead>
                    <tbody>
                        ${currentAdmins.map(admin => `
                            <tr>
                                <td>
                                    <div class="is-flex is-align-items-center gap-3">
                                        <div class="user-avatar ${admin.role === 'superadmin' ? 'avatar-superadmin' : 'avatar-admin'}">
                                            ${admin.username.charAt(0).toUpperCase()}
                                        </div>
                                        <div>
                                            <strong>${admin.username}</strong>
                                            <br><small class="has-text-grey">${admin.email}</small>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="tag ${admin.role === 'superadmin' ? 'tag-superadmin' : 'tag-admin'}">${admin.role === 'superadmin' ? '超级管理员' : '管理员'}</span></td>
                                <td><span class="tag ${admin.status === 'active' ? 'is-success' : 'is-grey'}">${admin.status === 'active' ? '活跃' : '停用'}</span></td>
                                <td>
                                    <button onclick="editAdmin('${admin.id}')" class="button is-small is-info is-outlined"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteAdmin('${admin.id}', '${admin.username}')" class="button is-small is-danger is-outlined" ${admin.role === 'superadmin' ? 'disabled' : ''}><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function updateStats() {
            document.getElementById('total-admins').textContent = currentAdmins.length;
            document.getElementById('superadmin-count').textContent = currentAdmins.filter(a => a.role === 'superadmin').length;
        }

        function openAddAdminModal() {
            document.getElementById('addAdminModal').classList.add('is-active');
        }

        function closeAddAdminModal() {
            document.getElementById('addAdminModal').classList.remove('is-active');
        }

        function closeEditAdminModal() {
            document.getElementById('editAdminModal').classList.remove('is-active');
        }

        async function addAdmin() {
            const data = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                email: document.getElementById('email').value,
                role: document.getElementById('role').value
            };

            try {
                const response = await fetch('/api/admins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeAddAdminModal();
                    loadAdmins();
                } else {
                    const error = await response.json();
                    alert(error.error || '创建失败');
                }
            } catch (error) {
                alert('创建失败');
            }
        }

        function editAdmin(adminId) {
            const admin = currentAdmins.find(a => a.id === adminId);
            if (!admin) return;

            document.getElementById('edit-admin-id').value = admin.id;
            document.getElementById('edit-username').value = admin.username;
            document.getElementById('edit-email').value = admin.email;
            document.getElementById('edit-role').value = admin.role;
            document.getElementById('edit-status').value = admin.status;

            document.getElementById('editAdminModal').classList.add('is-active');
        }

        async function updateAdmin() {
            const adminId = document.getElementById('edit-admin-id').value;
            const data = {
                email: document.getElementById('edit-email').value,
                role: document.getElementById('edit-role').value,
                status: document.getElementById('edit-status').value
            };

            try {
                const response = await fetch('/api/admins/' + adminId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    closeEditAdminModal();
                    loadAdmins();
                } else {
                    alert('更新失败');
                }
            } catch (error) {
                alert('更新失败');
            }
        }

        async function deleteAdmin(adminId, username) {
            if (!confirm(`确定删除管理员 "${username}"？`)) return;

            try {
                const response = await fetch('/api/admins/' + adminId, { method: 'DELETE' });
                if (response.ok) {
                    loadAdmins();
                } else {
                    const error = await response.json();
                    alert(error.error || '删除失败');
                }
            } catch (error) {
                alert('删除失败');
            }
        }

        document.addEventListener('DOMContentLoaded', loadAdmins);
    </script>
    
    {{codeBeforBody}}
</body>
</html>
