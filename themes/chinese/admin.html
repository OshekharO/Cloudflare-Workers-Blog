<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理后台 - {{siteName}}</title>
    
    <!-- Bulma CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chinese Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;500;600;700&family=ZCOOL+XiaoWei&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --chinese-red: #c41e3a;
            --chinese-red-dark: #8b0000;
            --chinese-gold: #d4a017;
            --ink-black: #1a1a1a;
            --ink-gray: #4a4a4a;
            --paper-cream: #faf8f5;
            --cloud-white: #fefefe;
        }
        
        * { font-family: 'Noto Serif SC', serif; }
        body { background: var(--paper-cream); min-height: 100vh; }
        
        .navbar-chinese {
            background: linear-gradient(135deg, var(--chinese-red) 0%, var(--chinese-red-dark) 100%);
        }
        
        .navbar-chinese .navbar-brand {
            font-family: 'ZCOOL XiaoWei', serif;
            color: var(--chinese-gold) !important;
        }
        
        .navbar-chinese .navbar-item {
            color: var(--paper-cream) !important;
        }
        
        .sidebar-chinese {
            background: var(--ink-black);
            min-height: calc(100vh - 52px);
            padding: 1.5rem 0;
        }
        
        .sidebar-chinese .menu-label {
            color: var(--chinese-gold);
            font-weight: 600;
            padding: 0 1rem;
        }
        
        .sidebar-chinese .menu-list a {
            color: rgba(255,255,255,0.7);
            padding: 0.75rem 1.5rem;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .sidebar-chinese .menu-list a:hover,
        .sidebar-chinese .menu-list a.is-active {
            background: rgba(196, 30, 58, 0.3);
            color: var(--paper-cream);
            border-left-color: var(--chinese-gold);
        }
        
        .content-area { padding: 2rem; }
        
        .card-chinese {
            background: var(--cloud-white);
            border-radius: 4px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.08);
            border: 1px solid rgba(212, 160, 23, 0.2);
        }
        
        .card-chinese .card-header {
            background: transparent;
            border-bottom: 1px solid rgba(212, 160, 23, 0.2);
            padding: 1rem 1.5rem;
        }
        
        .card-chinese .card-header-title {
            font-family: 'ZCOOL XiaoWei', serif;
            color: var(--ink-black);
        }
        
        .stat-card {
            background: var(--cloud-white);
            border-radius: 4px;
            padding: 1.5rem;
            border: 1px solid rgba(212, 160, 23, 0.2);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--paper-cream);
        }
        
        .stat-icon.red { background: linear-gradient(135deg, var(--chinese-red) 0%, var(--chinese-red-dark) 100%); }
        .stat-icon.gold { background: linear-gradient(135deg, var(--chinese-gold) 0%, #b8860b 100%); }
        .stat-icon.green { background: linear-gradient(135deg, #2d5a27 0%, #1a3d15 100%); }
        
        .btn-chinese {
            background: linear-gradient(135deg, var(--chinese-red) 0%, var(--chinese-red-dark) 100%);
            color: var(--paper-cream);
            border: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-chinese:hover {
            transform: translateY(-2px);
            color: var(--chinese-gold);
        }
        
        .tabs-chinese .tabs li a {
            border-bottom: 3px solid transparent;
            color: var(--ink-gray);
            font-weight: 500;
        }
        
        .tabs-chinese .tabs li.is-active a {
            border-bottom-color: var(--chinese-red);
            color: var(--chinese-red);
        }
        
        .table-chinese thead th {
            background: linear-gradient(135deg, var(--chinese-red) 0%, var(--chinese-red-dark) 100%);
            color: var(--paper-cream);
            font-weight: 500;
        }
        
        .tag-draft {
            background: var(--chinese-gold);
            color: var(--ink-black);
        }
        
        @media (max-width: 1024px) {
            .sidebar-chinese { min-height: auto; }
        }
    </style>
    
    {{codeBeforHead}}
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-chinese">
        <div class="container-fluid">
            <div class="navbar-brand">
                <span class="navbar-item"><i class="fas fa-cog me-2"></i>管理后台</span>
            </div>
            <div class="navbar-menu">
                <div class="navbar-end">
                    <a href="/" class="navbar-item"><i class="fas fa-eye me-1"></i> 查看博客</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="columns is-gapless">
        <!-- Sidebar -->
        <div class="column is-2 sidebar-chinese">
            <aside class="menu">
                <p class="menu-label">管理</p>
                <ul class="menu-list">
                    <li><a class="is-active" onclick="showTab('articles')"><i class="fas fa-file-alt me-2"></i>文章管理</a></li>
                    <li><a href="/admin/users"><i class="fas fa-users me-2"></i>用户管理</a></li>
                    <li><a onclick="showTab('tools')"><i class="fas fa-tools me-2"></i>工具</a></li>
                    <li><a href="/admin/edit"><i class="fas fa-plus me-2"></i>新建文章</a></li>
                </ul>
            </aside>
        </div>
        
        <!-- Content -->
        <div class="column content-area">
            <!-- Articles Tab -->
            <div id="articles-tab">
                <!-- Stats -->
                <div class="columns mb-5">
                    <div class="column">
                        <div class="stat-card is-flex is-align-items-center gap-3">
                            <div class="stat-icon red"><i class="fas fa-file-alt"></i></div>
                            <div>
                                <h3 class="title is-4 mb-0" id="total-articles">0</h3>
                                <p class="has-text-grey">文章总数</p>
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="stat-card is-flex is-align-items-center gap-3">
                            <div class="stat-icon green"><i class="fas fa-check-circle"></i></div>
                            <div>
                                <h3 class="title is-4 mb-0" id="published-count">0</h3>
                                <p class="has-text-grey">已发布</p>
                            </div>
                        </div>
                    </div>
                    <div class="column">
                        <div class="stat-card is-flex is-align-items-center gap-3">
                            <div class="stat-icon gold"><i class="fas fa-edit"></i></div>
                            <div>
                                <h3 class="title is-4 mb-0" id="drafts-count">0</h3>
                                <p class="has-text-grey">草稿</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Articles Card -->
                <div class="card card-chinese">
                    <header class="card-header">
                        <p class="card-header-title"><i class="fas fa-list me-2"></i>文章列表</p>
                        <a href="/admin/edit" class="button btn-chinese is-small m-2">
                            <i class="fas fa-plus me-1"></i> 新建
                        </a>
                    </header>
                    <div class="card-content">
                        <div class="tabs-chinese">
                            <div class="tabs">
                                <ul>
                                    <li class="is-active" onclick="switchTab('published')"><a>已发布</a></li>
                                    <li onclick="switchTab('drafts')"><a>草稿</a></li>
                                </ul>
                            </div>
                        </div>
                        
                        <div id="published-list"></div>
                        <div id="drafts-list" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <!-- Tools Tab -->
            <div id="tools-tab" style="display: none;">
                <div class="columns is-multiline">
                    <div class="column is-3">
                        <div class="card card-chinese has-text-centered p-4">
                            <i class="fas fa-download fa-2x has-text-success mb-3"></i>
                            <h4 class="title is-6">导出</h4>
                            <p class="is-size-7 has-text-grey mb-3">导出所有文章</p>
                            <button onclick="exportArticles()" class="button is-success is-small">导出</button>
                        </div>
                    </div>
                    <div class="column is-3">
                        <div class="card card-chinese has-text-centered p-4">
                            <i class="fas fa-upload fa-2x has-text-info mb-3"></i>
                            <h4 class="title is-6">导入</h4>
                            <p class="is-size-7 has-text-grey mb-3">导入JSON备份</p>
                            <button onclick="openImportModal()" class="button is-info is-small">导入</button>
                        </div>
                    </div>
                    <div class="column is-3">
                        <div class="card card-chinese has-text-centered p-4">
                            <i class="fas fa-rss fa-2x has-text-warning mb-3"></i>
                            <h4 class="title is-6">RSS</h4>
                            <p class="is-size-7 has-text-grey mb-3">查看RSS订阅</p>
                            <a href="/rss.xml" target="_blank" class="button is-warning is-small">打开</a>
                        </div>
                    </div>
                    <div class="column is-3">
                        <div class="card card-chinese has-text-centered p-4">
                            <i class="fas fa-sitemap fa-2x has-text-link mb-3"></i>
                            <h4 class="title is-6">站点地图</h4>
                            <p class="is-size-7 has-text-grey mb-3">查看Sitemap</p>
                            <a href="/sitemap.xml" target="_blank" class="button is-link is-small">打开</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-background" onclick="closeImportModal()"></div>
        <div class="modal-card">
            <header class="modal-card-head" style="background: var(--chinese-red);">
                <p class="modal-card-title has-text-white">导入文章</p>
                <button class="delete" onclick="closeImportModal()"></button>
            </header>
            <section class="modal-card-body">
                <div class="file is-boxed is-centered">
                    <label class="file-label">
                        <input class="file-input" type="file" id="importFile" accept=".json">
                        <span class="file-cta">
                            <span class="file-icon"><i class="fas fa-upload"></i></span>
                            <span class="file-label">选择JSON文件</span>
                        </span>
                    </label>
                </div>
            </section>
            <footer class="modal-card-foot">
                <button class="button" onclick="closeImportModal()">取消</button>
                <button class="button btn-chinese" onclick="importArticles()">导入</button>
            </footer>
        </div>
    </div>

    <script>
        function showTab(tab) {
            document.getElementById('articles-tab').style.display = tab === 'articles' ? 'block' : 'none';
            document.getElementById('tools-tab').style.display = tab === 'tools' ? 'block' : 'none';
        }

        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tabs-chinese .tabs li');
            tabs.forEach(t => t.classList.remove('is-active'));
            event.target.closest('li').classList.add('is-active');
            
            document.getElementById('published-list').style.display = tab === 'published' ? 'block' : 'none';
            document.getElementById('drafts-list').style.display = tab === 'drafts' ? 'block' : 'none';
        }

        async function loadArticles() {
            try {
                const response = await fetch('/api/articles');
                const articles = await response.json();
                
                document.getElementById('published-count').textContent = articles.length;
                document.getElementById('total-articles').textContent = articles.length;
                
                const container = document.getElementById('published-list');
                if (articles.length === 0) {
                    container.innerHTML = '<div class="has-text-centered py-5"><i class="fas fa-inbox fa-3x has-text-grey-light mb-3"></i><p class="has-text-grey">暂无已发布文章</p></div>';
                    return;
                }
                
                container.innerHTML = `
                    <table class="table is-fullwidth table-chinese">
                        <thead><tr><th>标题</th><th>分类</th><th>日期</th><th>操作</th></tr></thead>
                        <tbody>
                            ${articles.map(a => `
                                <tr>
                                    <td><strong>${a.title}</strong><br><small class="has-text-grey">/${a.permalink}</small></td>
                                    <td><span class="tag is-info">${a.label}</span></td>
                                    <td>${new Date(a.createDate).toLocaleDateString('zh-CN')}</td>
                                    <td>
                                        <a href="/admin/edit?permalink=${a.permalink}" class="button is-small is-info is-outlined"><i class="fas fa-edit"></i></a>
                                        <button onclick="deleteArticle('${a.permalink}')" class="button is-small is-danger is-outlined"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function loadDrafts() {
            try {
                const response = await fetch('/api/articles?drafts=true');
                const drafts = await response.json();
                
                document.getElementById('drafts-count').textContent = drafts.length;
                
                const container = document.getElementById('drafts-list');
                if (drafts.length === 0) {
                    container.innerHTML = '<div class="has-text-centered py-5"><i class="fas fa-edit fa-3x has-text-grey-light mb-3"></i><p class="has-text-grey">暂无草稿</p></div>';
                    return;
                }
                
                container.innerHTML = `
                    <table class="table is-fullwidth table-chinese">
                        <thead><tr><th>标题</th><th>分类</th><th>日期</th><th>操作</th></tr></thead>
                        <tbody>
                            ${drafts.map(d => `
                                <tr>
                                    <td><span class="tag tag-draft me-2">草稿</span><strong>${d.title}</strong></td>
                                    <td><span class="tag">${d.label}</span></td>
                                    <td>${new Date(d.createDate).toLocaleDateString('zh-CN')}</td>
                                    <td>
                                        <a href="/admin/edit?permalink=${d.permalink}" class="button is-small is-info is-outlined"><i class="fas fa-edit"></i></a>
                                        <button onclick="publishDraft('${d.permalink}')" class="button is-small is-success is-outlined"><i class="fas fa-paper-plane"></i></button>
                                        <button onclick="deleteArticle('${d.permalink}')" class="button is-small is-danger is-outlined"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function deleteArticle(permalink) {
            if (!confirm('确定删除这篇文章？')) return;
            try {
                await fetch('/api/articles/' + permalink, { method: 'DELETE' });
                loadArticles();
                loadDrafts();
            } catch (error) {
                alert('删除失败');
            }
        }

        async function publishDraft(permalink) {
            try {
                const response = await fetch('/api/articles/' + permalink);
                const draft = await response.json();
                draft.status = 'published';
                await fetch('/api/articles/' + permalink, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(draft)
                });
                loadArticles();
                loadDrafts();
            } catch (error) {
                alert('发布失败');
            }
        }

        async function exportArticles() {
            try {
                const response = await fetch('/api/export');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `blog-export-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
            } catch (error) {
                alert('导出失败');
            }
        }

        function openImportModal() {
            document.getElementById('importModal').classList.add('is-active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('is-active');
        }

        async function importArticles() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return alert('请选择文件');
            
            try {
                const text = await file.text();
                const response = await fetch('/api/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: text
                });
                const result = await response.json();
                alert(`成功导入 ${result.imported} 篇文章`);
                closeImportModal();
                loadArticles();
            } catch (error) {
                alert('导入失败');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadArticles();
            loadDrafts();
        });
    </script>
    
    {{codeBeforBody}}
</body>
</html>
